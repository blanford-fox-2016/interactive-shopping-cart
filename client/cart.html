<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shopping Cart</title>

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="index.html">Shopping Cart</a>
        </div>
        <ul class="nav navbar-nav">
            <li><a href="index.html">Home</a></li>
            <li><a href="customer.html">Customer</a></li>
            <li><a href="item.html">Item</a></li>
            <li><a href="cart.html">Cart</a></li>
        </ul>
    </div>
</nav>

<div class="container">

    <h1 class="text-center">Cart</h1>


    <form class="form-horizontal" id="cartForm">
        <div class="form-group">
            <label class="control-label col-sm-2">Member ID:</label>
            <div class="col-sm-10">
                <select name="memberId" class="form-control" id="selectCustomer">

                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-sm-2">Total:</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="total">
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-sm-2">Transaction Date:</label>
            <div class="col-sm-10">
                <input type="date" class="form-control" name="transactionDate">
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-sm-2">Item:</label>
            <div class="col-sm-10">
                <select name="itemCode" class="form-control" id="selectItem">

                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-sm-2">Price:</label>
            <div class="col-sm-10">
                <input type="number" class="form-control" name="price">
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-sm-2">Quantity:</label>
            <div class="col-sm-10">
                <input type="number" class="form-control" name="qty">
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
                <button type="submit" name="createCart" class="btn btn-default">Submit</button>
            </div>
        </div>
    </form>
</div>

<div class="container">
    <table class="table" id="rowOfCart">
        <tr>
            <td>No.</td>
            <td>Member ID</td>
            <td>Total</td>
            <td>Transaction Date</td>
            <td>Item List</td>
            <td>Action</td>
        </tr>

    </table>
</div>

<script src="javascripts/jquery-3.1.1.min.js"></script>
<script src="javascripts/bootstrap.min.js"></script>

<script>
    $( document ).ready(function() {
        var selectCustomer = $('#selectCustomer')
        $.ajax({
            url: "http://localhost:3000/api/customer",
            success: function (data) {

                $.extend({}, data)
                var customers = []

                for (var i = 0; i < data.length; i++) {
                    customers.push(`
                                    <option value="${data[i].memberId}">${data[i].memberId}</option>
                                   `)
                }

                selectCustomer.append(customers.join(""))
            }
        })


        var selectItem = $('#selectItem')
        $.ajax({
            url: "http://localhost:3000/api/item",
            success: function (data) {

                $.extend({}, data)
                var item = []

                for (var i = 0; i < data.length; i++) {
                    item.push(`
                               <option value="${data[i].itemCode}">${data[i].name}</option>
                              `)
                }

                selectItem.append(item.join(""))
            }
        })

        var rowOfCart = $('#rowOfCart')
        $.ajax({
            url: "http://localhost:3000/api/cart",
            success: function (data) {

                $.extend({}, data)
                var cart = []

                for (let i = 0; i < data.length; i++) {
                    cart.push(`<tr id="rowCart${data[i]._id}">
                                <td>${i + 1}</td>
                                </td><td>${data[i].memberId}</td>
                                <td>${data[i].total}</td>
                                <td>${data[i].transactionDate}</td>`)

                    cart.push(`<td>`)
                    for (let j = 0; j < data[i].itemList.length; j++) {
                        cart.push(`${data[i].itemList[j].itemCode}, `)
                    }
                    cart.push(`</td>`)

                    cart.push(`<td><span>
                                <button id="buttonEditCart${data[i]._id}" class="btn btn-warning" onclick="editCart('${data[i]._id}')">Edit</button>
                                <button id="buttonDeleteCart${data[i]._id}" class="btn btn-danger" onclick="deleteCart('${data[i]._id}')">Delete</button>
                                </span></td></tr>`)
                }

                rowOfCart.append(cart.join(""))
            }
        })
    })

    $(document).on('click', 'button[name="createCart"]', function(e) {
        e.preventDefault()
        var memberId = $("select[name='memberId']").val()
        var total = $("input[name='total']").val()
        var transactionDate = $("input[name='transactionDate']").val()
        var itemCode = $("select[name='itemCode']").val()
        var qty = $("input[name='qty']").val()
        var price = $("input[name='price']").val()
        addCartFromAPI(memberId, total, transactionDate, itemCode, qty, price)
    })

    function addCartFromAPI(memberId, total, transactionDate, itemCode, qty, price) {
        $.ajax({
            url: "http://localhost:3000/api/cart/create",
            method: "post",
            contentType: 'application/x-www-form-urlencoded',
            data: {
                memberId: memberId,
                total: total,
                transactionDate: transactionDate,
                itemCode: itemCode,
                qty: qty,
                price: price

            },
            success: function (cart) {
                updateCreateCart(cart.cart)
            }
        })
    }

    function updateCreateCart(cart) {
        console.log(cart)
        var no = $('tr').length
        var html = `<tr id="rowCart${cart._id}">
                        <td>${no}</td>
                        <td>${cart.memberId}</td>
                        <td>${cart.total}</td>
                        <td>${cart.transactionDate}</td>
                        <td>`
                        for(var i = 0; i<cart.itemList.length; i++) {
                            cart.itemList[i].itemCode
                        }
                        `</td>

                        <td>
                            <span>
                                <button id="buttonEditItem${cart._id}" class="btn btn-warning" onclick="editCart('${cart._id}')">Edit</button>
                                <button id="buttonDeleteItem${cart._id}" class="btn btn-danger" onclick="deleteCart('${cart._id}')">Delete</button>
                            </span>
                        </td>
                    </tr>`

        $("tbody:last").append(html)
        $("input[name='memberId']").val("")
        $("input[name='total']").val("")
        $("input[name='transactionDate']").val("")
        $("input[name='itemList']").val("")
    }

    function deleteCart(id) {
        console.log(id)
        var del = confirm("Are you sure you want to delete this cart?")
        if (del) {
            deleteCartFromAPI(id)
        }
    }

    function deleteCartFromAPI(id) {
        var temp = id
        $.ajax({
            url: `http://localhost:3000/api/cart/delete/${id}`,
            method: "delete",
            contentType: 'application/x-www-form-urlencoded',
            data: {
                id: id
            },
            success: function () {
                updateDeleteCart(temp)
            }
        })
    }

    function updateDeleteCart(id) {
        console.log(id)
        $("tbody").find(`#rowCart${id}`).remove()
        $("input[name='memberId']").val("")
        $("input[name='total']").val("")
        $("input[name='transactionDate']").val("")
        $("input[name='itemList']").val("")
    }

    function editCart(id) {
        getCartFromAPI(id)
    }

    function getCartFromAPI(id) {
        $.ajax({
            url: `http://localhost:3000/api/cart/update/${id}`,
            method: "get",
            contentType: 'application/x-www-form-urlencoded',
            data: {
                id: id
            },
            success: function (cart) {
                getCart(cart.cart)
            }
        })
    }

    function getCart(cart) {
        var memberId = `select[name=memberId]`
        var total = `input[name=total]`
        var transactionDate = `input[name=transactionDate]`
        var itemList = `select[name=itemCode]`
        var price = `input[name=price]`
        var qty = `input[name=qty]`

        $("form").find(memberId).val(cart.memberId)
        $("form").find(total).val(cart.total)
        $("form").find(transactionDate).attr('disabled', true)
        $("form").find(itemList).attr('disabled', true)
        $("form").find(price).attr('disabled', true)
        $("form").find(qty).attr('disabled', true)
        $("form").find("button[name=createCart]").replaceWith(`<button type='submit' name='updateCart' class='btn btn-default'>Update</button>`)

        var temp = $("input[name='id']").val()
        if ( typeof temp != "undefined") {
            $("input[name='id']").replaceWith(`<input type='hidden' class='form-control' name='id' value='${cart._id}'>`)
        }
        else {
            $(".form-group:first").append(`<input type='hidden' class='form-control' name='id' value='${cart._id}'>`)
        }

    }

    $(document).on('click', 'button[name="updateCart"]', function(e) {
        e.preventDefault()
        updateCartFromAPI(
                $("input[name='id']").val(),
                $("select[name='memberId']").val(),
                $("input[name='total']").val()
        )

    });

    function updateCartFromAPI(id, memberId, total) {
        $.ajax({
            url: `http://localhost:3000/api/cart/update/${id}`,
            method: "put",
            contentType: 'application/x-www-form-urlencoded',
            data: {
                id: id,
                memberId: memberId,
                total: total
            },
            success: function (data) {
                console.log(data)
                updateUpdateCart(data.cart)
            }
        })
    }

    function updateUpdateCart(cart) {
        var html = `<tr id="rowItem${cart._id}">
                        <td>tar</td>
                        <td>${cart.memberId}</td>
                        <td>${cart.total}</td>
                        <td>${cart.transactionDate}</td>
                        <td>${cart.itemList}</td>
                        <td>
                            <span>
                                <button id="buttonEditCart${cart._id}" class="btn btn-warning" onclick="editCart('${cart._id}')">Edit</button>
                                <button id="buttonDeleteCart${cart._id}" class="btn btn-danger" onclick="deleteCart('${cart._id}')">Delete</button>
                            </span>
                        </td>
                    </tr>`
        $("tbody").find(`#rowCart${cart._id}`).replaceWith(html)

        $("form").find("button[name=updateCart]").replaceWith("<button type='submit' name='createCart' class='btn btn-default'>Submit</button>")
        $("input[name='memberId']").val("")
        $("input[name='total']").val("")
        $("input[name='transactionDate']").val("").attr('disabled', false)
        $("select[name='itemList']").attr('disabled', false)
        $("input[name='price']").val("").attr('disabled', false)
        $("input[name='qty']").val("").attr('disabled', false)

    }



</script>

</body>
</html>
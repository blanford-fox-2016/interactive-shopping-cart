<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shopping Cart</title>

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="container">

    <h1 class="text-center">Customer</h1>

    <form class="form-horizontal" id="customerForm">
        <div class="form-group">
            <label class="control-label col-sm-2">Name:</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="name">
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-sm-2">Member ID:</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="memberId">
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-sm-2">Address:</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="address">
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-sm-2">ZIP:</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="zip">
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-sm-2">Phone:</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="phone">
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
                <button type="submit" name="createCustomer" class="btn btn-default">Submit</button>
            </div>
        </div>
    </form>
</div>

<div class="container">
    <table class="table" id="rowOfCustomers">
        <tr>
            <td>No.</td>
            <td>Name</td>
            <td>Member ID</td>
            <td>Address</td>
            <td>ZIP</td>
            <td>Phone</td>
            <td>Action</td>
        </tr>

    </table>
</div>

<script src="javascripts/jquery-3.1.1.min.js"></script>
<script src="javascripts/bootstrap.min.js"></script>

<script>
    $( document ).ready(function() {
        var rowOfCustomers = $('#rowOfCustomers')
        $.ajax({
            url: "http://localhost:3000/api/customer",
            success: function (data) {

                $.extend({}, data)
                var customers = []

                for (var i = 0; i < data.length; i++) {
                    customers.push(`<tr id="rowCustomer${data[i]._id}">
                                        <td>${i + 1}</td>
                                        <td>${data[i].name}
                                        </td><td>${data[i].memberId}</td>
                                        <td>${data[i].address}</td><td>${data[i].zip}</td>
                                        <td>${data[i].phone}</td>
                                        <td>
                                            <span>
                                                <button id="buttonEditCustomer${data[i]._id}" class="btn btn-warning" onclick="editCustomer('${data[i]._id}')">Edit</button>
                                                <button id="buttonDeleteCustomer${data[i]._id}" class="btn btn-danger" onclick="deleteCustomer('${data[i]._id}')">Delete</button>
                                            </span>
                                        </td>
                                     </tr>`)
                }

                rowOfCustomers.append(customers.join(""))
            }
        })
    })

    $(document).on('click', 'button[name="createCustomer"]', function(e) {
        console.log("FIRED!!!!")
        e.preventDefault()
        var name = $("input[name='name']").val()
        var memberId = $("input[name='memberId']").val()
        var address = $("input[name='address']").val()
        var zip = $("input[name='zip']").val()
        var phone = $("input[name='phone']").val()
        addCustomerFromAPI(name, memberId, address, zip, phone)
    })

    function addCustomerFromAPI(name, memberId, address, zip, phone) {
        $.ajax({
            url: "http://localhost:3000/api/customer/create",
            method: "post",
            contentType: 'application/x-www-form-urlencoded',
            data: {
                name: name,
                memberId: memberId,
                address: address,
                zip: zip,
                phone: phone
            },
            success: function (customer) {
                updateCreateCustomer(customer.customer)
            }
        })
    }

    function updateCreateCustomer(customer) {
        var no = $('tr').length
        var html = `<tr id="rowCustomer${customer._id}">
                        <td>${no}</td>
                        <td>${customer.name}</td>
                        <td>${customer.memberId}</td>
                        <td>${customer.address}</td>
                        <td>${customer.zip}</td>
                        <td>${customer.phone}</td>
                        <td>
                            <span>
                                <button id="buttonEditCustomer${customer._id}" class="btn btn-warning" onclick="editCustomer('${customer._id}')">Edit</button>
                                <button id="buttonDeleteCustomer${customer._id}" class="btn btn-danger" onclick="deleteCustomer('${customer._id}')">Delete</button>
                            </span>
                        </td>
                    </tr>`

        $("tbody:last").append(html)
        $("input[name='name']").val("")
        $("input[name='memberId']").val("")
        $("input[name='address']").val("")
        $("input[name='zip']").val("")
        $("input[name='phone']").val("")
    }

    function deleteCustomer(id) {
        console.log(id)
        var del = confirm("Are you sure you want to delete this customer?")
        if (del) {
            deleteCustomerFromAPI(id)
        }
    }

    function deleteCustomerFromAPI(id) {
        var temp = id
        $.ajax({
            url: `http://localhost:3000/api/customer/delete/${id}`,
            method: "delete",
            contentType: 'application/x-www-form-urlencoded',
            data: {
                id: id
            },
            success: function () {
                updateDeleteCustomer(temp)
            }
        })
    }

    function updateDeleteCustomer(id) {
        console.log(id)
        $("tbody").find(`#rowCustomer${id}`).remove()
        $("input[name='name']").val("")
        $("input[name='memberId']").val("")
        $("input[name='address']").val("")
        $("input[name='zip']").val("")
        $("input[name='phone']").val("")
    }
    
    function editCustomer(id) {
        getCustomerFromAPI(id)
    }

    function getCustomerFromAPI(id) {
        $.ajax({
            url: `http://localhost:3000/api/customer/update/${id}`,
            method: "get",
            contentType: 'application/x-www-form-urlencoded',
            data: {
                id: id
            },
            success: function (customer) {
                getCustomer(customer.customer)
            }
        })
    }

    function getCustomer(customer) {
        var name = `input[name=name]`
        var memberId = `input[name=memberId]`
        var address = `input[name=address]`
        var zip = `input[name=zip]`
        var phone = `input[name=phone]`

        $("form").find(name).val(customer.name)
        $("form").find(memberId).val(customer.memberId)
        $("form").find(address).val(customer.address)
        $("form").find(zip).val(customer.zip)
        $("form").find(phone).val(customer.phone)
        $("form").find("button[name=createCustomer]").replaceWith(`<button type='submit' name='updateCustomer' class='btn btn-default'>Update</button>`)

        var temp = $("input[name='id']").val()
        if ( typeof temp != "undefined") {
            $("input[name='id']").replaceWith(`<input type='hidden' class='form-control' name='id' value='${customer._id}'>`)
        }
        else {
            $(".form-group:first").append(`<input type='hidden' class='form-control' name='id' value='${customer._id}'>`)
        }

    }

    $(document).on('click', 'button[name="updateCustomer"]', function(e) {
        e.preventDefault()
        updateCustomerFromAPI(
            $("input[name='id']").val(),
            $("input[name='name']").val(),
            $("input[name='memberId']").val(),
            $("input[name='address']").val(),
            $("input[name='zip']").val(),
            $("input[name='phone']").val()
        )

    });

    function updateCustomerFromAPI(id, name, memberId, address, zip, phone) {
        $.ajax({
            url: `http://localhost:3000/api/customer/update/${id}`,
            method: "put",
            contentType: 'application/x-www-form-urlencoded',
            data: {
                id: id,
                name: name,
                memberId: memberId,
                address: address,
                zip: zip,
                phone: phone
            },
            success: function (data) {
                console.log(data)
                updateUpdateCustomer(data.customer)
            }
        })
    }

    function updateUpdateCustomer(customer) {
        console.log(customer)
        var html = `<tr id="rowCustomer${customer._id}">
                        <td>tar</td>
                        <td>${customer.name}</td>
                        <td>${customer.memberId}</td>
                        <td>${customer.address}</td>
                        <td>${customer.zip}</td>
                        <td>${customer.phone}</td>
                        <td>
                            <span>
                                <button id="buttonEditCustomer${customer._id}" class="btn btn-warning" onclick="editCustomer('${customer._id}')">Edit</button>
                                <button id="buttonDeleteCustomer${customer._id}" class="btn btn-danger" onclick="deleteCustomer('${customer._id}')">Delete</button>
                            </span>
                        </td>
                    </tr>`
        $("tbody").find(`#rowCustomer${customer._id}`).replaceWith(html)

        $("form").find("button[name=updateCustomer]").replaceWith("<button type='submit' name='createCustomer' class='btn btn-default'>Submit</button>")
        $("input[name='name']").val("")
        $("input[name='memberId']").val("")
        $("input[name='address']").val("")
        $("input[name='zip']").val("")
        $("input[name='phone']").val("")
    }



</script>

</body>
</html>